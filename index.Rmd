---
title: "Visualiza√ß√£o de dados em ggplot"
subtitle: ""
author: "Guilherme D. Garcia e Ronaldo Lima Jr."
institute: "‚Ä¢ Universit√© Laval e UnB‚Ä¢"
date: ""
output:
  xaringan::moon_reader:
    css: ["default", "default-fonts", "myStyles.css"]
    lib_dir: libs
    includes:
      after_body: "myStyles.css"
    nature:
      ratio: '16:9'
      center: true
      slideNumberFormat: "%current% de %total%"
      highlightLines: true
      countIncrementalSlides: false
    seal: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(Hmisc)
library(languageR)
data(english)

options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```

class: title-slide, inverse, center, middle

# Workshop
## Visualiza√ß√£o de dados com ggplot
<a href = "https://gdgarcia.ca" style="color: #FEC20B">Guilherme D. Garcia</a> | Universit√© Laval ‚Ä¢ Centre for Research on Brain, Language & Music (CRBLM) 

<a href = "http://ronaldolimajr.github.io" style="color: #FEC20B">Ronaldo Lima Jr.</a> | Universidade de Bras√≠lia ‚Ä¢ CNPq


<!-- #### Universit√© Laval ‚Ä¢ Centre for Research on Brain, Language & Music (CRBLM) -->
<!-- #### Universidade de Bras√≠lia ‚Ä¢ CNPq -->

---

```{r xaringanExtra, echo=FALSE}
# xaringanExtra::use_tile_view()
xaringanExtra::use_scribble()
xaringanExtra::use_clipboard(button_text = "Clique para copiar", success_text = "Copiado!")
# xaringanExtra::use_search(show_icon = TRUE)
xaringanExtra::use_progress_bar(location = "bottom", color = "darkred")
options(htmltools.dir.version = FALSE)
xaringanExtra::use_editable()
xaringanExtra::use_panelset()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = FALSE  #<<
)

```

## Apresenta√ß√£o

---

## Question√°rio

- MS Forms

---

## Prepara√ß√£o

- Dados utilisados: <mark>`english`</mark> (pacote `languageR`)

```{r}
data(english)
english = english |> 
  select(RTlexdec, Familiarity, Word, AgeSubject)
glimpse(english)
```


---



## Tipos de gr√°ficos

### y cont√≠nuo e x categ√≥rico

```{r, out.width="50%", echo=FALSE, cache=TRUE, fig.height=4, fig.width = 5, message = FALSE, dpi=500}
ggplot(data =english, aes(x = AgeSubject, y = RTlexdec)) + 
  # stat_summary(geom = "bar", width = 0.5, 
  #              fill = "darkorange2", alpha = 0.5,
  #              color = "black") +
  stat_summary() + 
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(title = "M√©dia e erro padr√£o")

ggplot(data =english, aes(x = AgeSubject, y = RTlexdec)) + 
  stat_summary(geom = "bar", width = 0.5, 
               fill = "darkorange2", alpha = 0.5,
               color = "black") +
  stat_summary() + 
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(title = "Com barras")


```

---

## Tipos de gr√°ficos

### y cont√≠nuo e x categ√≥rico

```{r, out.width="50%", echo=FALSE, cache=TRUE, fig.height=4, fig.width = 5, message = FALSE, dpi=500}
ggplot(data = english, aes(x = AgeSubject, y = RTlexdec)) + 
  geom_boxplot(fill = "darkorange2", alpha = 0.5) +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(title = "Gr√°fico de caixas")

ggplot(data =english, aes(x = AgeSubject, y = RTlexdec)) + 
  geom_violin(fill = "darkviolet", alpha = 0.5) +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(title = "Gr√°fico de violino")


```

---

## Tipos de gr√°ficos

### y e x cont√≠nuos

```{r, out.width="50%", echo=FALSE, cache=TRUE, fig.height=4, fig.width = 5, message = FALSE, dpi=500}
ggplot(data = english, aes(x = Familiarity, y = RTlexdec)) + 
  geom_point(color = "darkorange2", alpha = 0.2) +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(title = "Gr√°fico de dispers√£o")

ggplot(data =english, aes(x = Familiarity, y = RTlexdec)) + 
  geom_point(color = "darkviolet", alpha = 0.2) +
  geom_smooth(method = "lm", color = "black") +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(title = "Gr√°fico de dispers√£o + tend√™ncia",
       subtitle = "Uma √∫nica linha de tend√™ncia")


```

---

## Tipos de gr√°ficos

### y e x cont√≠nuos + z categ√≥rico

.pull-left[
  

```{r, out.width="95%", echo=FALSE, cache=TRUE, fig.height=4, fig.width = 5, message = FALSE, dpi=500, fig.align='center'}

colours = c("darkorange", "royalblue")
names(colours) = c("old", "young")

customSub = glue::glue('Tempos de rea√ß√£o para
       <span style="color:{colours["old"]}">**old**</span> 
       e 
       <span style="color:{colours["young"]}">**young**</span>')

ggplot(data = english, aes(x = Familiarity, y = RTlexdec, color = AgeSubject)) + 
  geom_point(alpha = 0.2) +
  theme_classic() +
  scale_color_manual(values = c("darkorange2", "royalblue")) +
  stat_smooth(method = "lm") +
  theme(text = element_text(size = 15),
        plot.subtitle = ggtext::element_markdown(),
        legend.position = "none") +
  labs(title = "Gr√°fico de dispers√£o",
       subtitle = customSub)
```
]

.pull-right[

- Terceira vari√°vel (idade) + cor em subt√≠tulo

- Duas linhas de tend√™ncia

- Bom grau de informa√ß√£o e f√°cil leitura üòÉ

- Eixos podem melhorar (qual a escala de $y$?)  ü§®

]




---

## Boas pr√°ticas

### Alguns pontos a considerar

.pull-left[


- Gr√°fico apropriado aos dados

- Quantidade apropriada de informa√ß√£o

- Tamanho (e tipo) de fonte

- Clareza de vari√°veis

- Uso consistente de cores

- Alinhamento entre figura e an√°lise

- Consist√™ncia ao longo do documento
]

.pull-right[

- Defini√ß√£o apropriada (‚â•500 `dpi`) ü´†

```{r, out.width="90%", echo=FALSE, cache=TRUE, fig.height=4, fig.width = 5, message = FALSE, dpi=80, fig.align='center'}

colours = c("darkorange", "royalblue")
names(colours) = c("old", "young")

customSub = glue::glue('Tempos de rea√ß√£o para
       <span style="color:{colours["old"]}">**old**</span> 
       e 
       <span style="color:{colours["young"]}">**young**</span>')

ggplot(data = english, aes(x = Familiarity, y = RTlexdec, color = AgeSubject)) + 
  geom_point(alpha = 0.2) +
  theme_classic() +
  scale_color_manual(values = c("darkorange2", "royalblue")) +
  stat_smooth(method = "lm") +
  theme(text = element_text(size = 8),
        plot.subtitle = ggtext::element_markdown(),
        legend.position = "none") +
  labs(title = "Gr√°fico de dispers√£o",
       subtitle = customSub)
```

]


---

## Exemplo n√£o acad√™mico: The Economist

.pull-left[

.center[<img src="econ1.png" width="75%"/>]

]

.pull-right[

.center[<img src="econ2.png" width="75%" />]

]


---

## Exemplo acad√™mico: resumo para congresso

.center[<img src="example.png" width="85%"/>]

---


## Pain√©is (*facets*)

- Dados no **eixo y** comparados: um √∫nico eixo y com todos os pain√©is alinhados horizontalmente<sup>`*`</sup>
- Dados no **eixo x** comparados: pain√©is empilhados
- Matriz se os dados de cada painel n√£o estiverem relacionados ou se o espa√ßo for muito pequeno

<!-- ### Exemplo -->


```{r, echo=FALSE, message=FALSE, out.width="72%", cache=TRUE, fig.height=4.3, fig.width = 9, message = FALSE, dpi=500, fig.align='center'}

# Data set creation.
set.seed(93384)

time <- c(0, 0.5, 1, 2, 4, 8, 12, 16, 24)
n <- 32 # no of subjects

data <- expand.grid(ID = 1:n, time = time)

bw <- data.frame(
  ID = sort(unique(data$ID)),
  bw = rlnorm(n, log(75), sdlog = 0.25)
)

bw$bw.category <- cut(bw$bw,
  breaks = quantile(bw$bw, c(0, 0.33, 0.66, 1)),
  labels = paste(c("low", "medium", "high"), "body weight"),
  include.lowest = TRUE
)

data <- merge(data, bw)

data <- data[order(data$ID, data$time), ]

# Simulate drug concentrations as a function of body weight.
data$conc <- 100 / (data$bw^1.0) * exp(-0.085 * data$time) *
  rlnorm(nrow(data), sdlog = 0.25) + # res. error
  (data$ID - mean(data$ID)) / mean(data$ID) / 4 # r. eff

# ---
# Visualisation.
library(ggplot2)

gg <- list()

data$ID <- factor(data$ID)

gg[["3x1"]] <- ggplot(data, aes(x = time, y = conc, group = ID, color = ID)) +
  geom_line()
gg[["3x1"]] <- gg[["3x1"]] + scale_x_continuous(breaks = seq(0, 24, by = 4))
gg[["3x1"]] <- gg[["3x1"]] + theme_bw() + 
  xlab("time [h]") + 
  ylab("drug concentration [ng/mL]")
gg[["3x1"]] <- gg[["3x1"]] + facet_grid(bw.category ~ .)
gg[["3x1"]] <- gg[["3x1"]] + theme(legend.position = "none")

gg[["1x3"]] <- gg[["3x1"]] + facet_grid(. ~ bw.category)

# Add space to the rhs of the first figure for better separation in the cowplot.
gg[["3x1"]] <- gg[["3x1"]] + 
  theme(plot.margin = unit(c(0.5, 4, 0.5, 0.5), "lines"))

# Both figures into a single output figure.
library(cowplot)
plot_grid(gg[[1]], gg[[2]], rel_widths = c(1.5, 2))
```


.footnote[`*` Fonte: <https://royal-statistical-society.github.io/datavisguide/>]

---

## Propor√ß√£o de tela (*aspect ratio*)

- Uma figura quadrada evita vi√©s visual na escolha dos eixos y e x<sup>`*`</sup>
- Uma figura quadrada deve ser considerada se os dois eixos t√™m algo em comum:
   + pr√© *vs* p√≥s
   + dados observados *vs* valores previstos pelo modelo
   + mesmas unidades


```{r, echo=FALSE, message=FALSE, out.width="74%", cache=TRUE, fig.height=3.5, fig.width = 8, message = FALSE, dpi=500, fig.align='center'}

# Observed vs predicted (any data with comparable x and y will do).

# ---
# Data set.
# Old Faithful Geyser (Yellowstone) data set with eruption duration
#   and waiting time to the next eruption (both in minutes).
data <- data.frame(
  x = faithful$eruptions,
  y = faithful$waiting
)

# ---
# Regression model fit.
fit <- lm(y ~ x, data = data)

# Addition of predicted values to the data set.
data$pred <- predict(fit)

# Range of y and y predicted combined.
r <- range(unlist(data[c("y", "pred")]))

# ---
# Plotting.

library(ggplot2)

gg <- ggplot(data, aes(x = pred, y = y))

# Adding the line of identity, y = x
# (note: plotting it first will add points on top).
gg <- gg + geom_abline(intercept = 0, slope = 1, color = "black", linewidth = 1)

# Adding points, removing grey background.
gg <- gg + geom_point() + theme_bw()

# Adding regression fit (local smoother, loess) of y~x.
gg <- gg + geom_smooth(method = "loess", color = "firebrick", se = FALSE)

# Adding axis labels.
gg <- gg + xlab("predicted") + ylab("observed")

# Aspect ratios are commonly not fixed but adapted to figure size.
#   With dynamic displays, the point of different perception
#   might not be obvious depending on the figure/screen size.
#   To make that point independent of figure height and width,
#     the aspect ratio is fixed in this example.
gg <- gg + coord_fixed(ratio=0.5)

# Copy the figure and fix the aspect ratio to 2, i.e., 
#   one pixel in x corresponds to 2 pixels in y.
gg2 <- gg + coord_fixed(ratio=2)

# Setting the aspect ratio to 1 (1 unit in x and y 
#   corresponds to the same number of pixels) and 
#   setting axis limits to be identical.
gg3 <- gg + coord_fixed(ratio=1, xlim=r, ylim=r)

# Cow (column-wise) plot, combine all figures into one.
library(cowplot)
plot_grid(gg, gg2, gg3, rel_widths = c(4, 2, 3), nrow = 1)
```

.footnote[`*` Fonte: <https://royal-statistical-society.github.io/datavisguide/>]

---

## Eixos

- O eixo deve come√ßar em 0 (a menos que haja um bom motivo para escolher outros intervalos)<sup>`*`</sup>
- Se os dados n√£o contiverem valores negativos, o eixo n√£o dever√° se estender para valores negativos
- Se os dados exibidos forem compar√°veis, os limites dos eixos dever√£o ser id√™nticos

.footnote[`*` Fonte: <https://royal-statistical-society.github.io/datavisguide/>]

```{r, echo=FALSE, message=FALSE, out.width="78%", cache=TRUE, fig.height=3, fig.width = 8, message = FALSE, dpi=500, fig.align='center'}

plot_data <- data.frame(
  type = factor(
    c("Our product", "Competitor"),
    levels = c("Our product", "Competitor")
  ),
  value = c(220, 210)
)

# Original plot
gg1 = ggplot(plot_data) +
  geom_col(
    mapping = aes(x = type, y = value),
    fill = "lightblue",
    colour = "black"
  ) +
  scale_y_continuous(breaks = seq(0, 220, by = 20), expand = c(0, 0)) +
  labs(x = "", y = "") +
  theme_minimal()

# Offset the y axis
offset <- 208
gg2 = ggplot(plot_data) +
  geom_col(
    mapping = aes(x = type, y = value - offset),
    fill = "lightblue",
    colour = "black"
  ) +
  scale_y_continuous(
    breaks = seq(0, 14, by = 2),
    labels = seq(0 + offset, 14 + offset, by = 2),
    expand = c(0, 0)
  ) +
  labs(x = "", y = "") +
  theme_minimal()

# Cow (column-wise) plot, combine all figures into one.
library(cowplot)
plot_grid(gg1, gg2, nrow = 1)

```


---
class: center, middle

## Introdu√ß√£o ao `ggplot2`


<iframe src="https://giphy.com/embed/XIqCQx02E1U9W" width="480" height="269" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/XIqCQx02E1U9W"></a></p>

---


## Pacotes

- Antes de irmos ao RStudio: estes s√£o os pacotes que usaremos

```{r, eval=FALSE}
library(tidyverse) # ggplot2, tidyr, etc.
library(Hmisc)     # para complementar estat√≠stica b√°sica em ggplot2
library(scales)    # para eixos mais flex√≠veis
library(languageR) # dados
```

- Importante: h√° **outros** pacotes para visualiza√ß√£o de dados. O `ggplot2` √© apenas o mais completo

- `plotly`, `lattice`, `base`, `leaflet`, `ggvis`, ...


---

## No√ß√£o de camadas

- A ideia b√°sica de um gr√°fico com `ggplot2` envolve <mark>**camadas**</mark>

- Camadas s√£o ordenadas linearmente: a camada $n$ ser√° gerada *antes* de $n+1$

- A primeira camada (base) define a origem dos dados, que ser√° "herdada" por outras camadas

```{r, eval = FALSE, message = FALSE}
camada_base(dados, aes(x = ..., y = ..., color = ..., ...)) +
 camada_1() + 
 camada_2() +
 ...+
 camada_n()
```

- Apesar dessa "heran√ßa autom√°tica", camadas tamb√©m podem ter certa independ√™ncia

- Isso nos permite utilizar mais de uma base de dados ao mesmo tempo ü§Ø

---

## Introdu√ß√£o ao `ggplot2`

```{r, out.width="70%", echo=TRUE, cache=TRUE, fig.height=2.5, fig.width = 5, fig.align='center', message = FALSE, dpi=500}
ggplot(data = english, aes(x = AgeSubject,      # Camada de base: dados
                           y = RTlexdec)) + 
  stat_summary(geom = "bar", width = 0.5) +     # Camada que determina tipo de gr√°fico
  labs(x = "Idade", y = "Tempo de rea√ß√£o")      # Camada que nomeia os eixos

```

<!-- --- -->

<!-- ## Visualiza√ß√£o descritiva -->

<!-- --- -->

<!-- ## Pr√°tica -->

